SHELL	= /bin/sh
WARN    = -Wmissing-prototypes
OPTS	= "CC=$(CC)"
DIRS	= util global dns master postfix smtpstone sendmail error \
	pickup cleanup smtpd local trivial-rewrite qmgr smtp bounce pipe \
	showq postalias postcat postconf postdrop postkick postlock postlog \
	postmap postsuper # spawn man html

default: update

makefiles Makefiles:
	set -e; for i in $(DIRS); do \
	 (set -e; echo "[$$i]"; cd $$i; rm -f Makefile; \
	 $(MAKE) -f Makefile.in Makefile MAKELEVEL=) || exit 1; \
	done;
	rm -f Makefile; (set -e; $(SHELL) makedefs && cat Makefile.in) >Makefile

update printfck:
	set -e; for i in $(DIRS); do \
	 (set -e; echo "[$$i]"; cd $$i; $(MAKE) $(OPTS) $@ MAKELEVEL=) || exit 1; \
	done

printfck: update

install: update
	sh INSTALL.sh

depend clean:
	set -e; for i in $(DIRS); do \
	 (set -e; echo "[$$i]"; cd $$i; $(MAKE) $@) || exit 1; \
	done

depend_update:
	set -e; for i in $(DIRS); do \
	 (set -e; echo "[$$i]"; cd $$i; $(MAKE) depend && $(MAKE) $(OPTS) update) \
	    || exit 1; \
	done

tidy:	clean
	rm -f Makefile */Makefile
	cp Makefile.init Makefile
	-rm -f junk *core */*core .nfs* .pure bin/* lib/* include/* libexec/* \
	*/.nfs* */.pure *.out */*.out */*.db */*.a *~ */*~ *- */*- *.orig \
	*/*.orig *.bak */*.bak make.err conf/main.cf.default
	find . -type s -print | xargs rm -f
	find . -type d -print | xargs chmod 755
	find . -type f -print | xargs chmod a+r
