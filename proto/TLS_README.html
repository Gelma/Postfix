<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>

<head>

<title>Postfix TLS Support </title>

<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">

</head>

<body>

<h1><img src="postfix-logo.jpg" width="203" height="98" ALT="">Postfix TLS Support
</h1>

<hr>

<h2> WARNING </h2>

<p> By turning on TLS support in Postfix, you not only get the
ability to encrypt mail and to authenticate clients or servers.
You also turn on thousands and thousands of lines of OpenSSL library
code.  Assuming that OpenSSL is written as carefully as Wietse's
own code, every 1000 lines introduce one additional bug into
Postfix.  </p>

<h2> What Postfix TLS support does for you </h2>

<p> Transport Layer Security (TLS, formerly called SSL) provides
certificate-based authentication and encrypted sessions.  An
encrypted session protects the information that is transmitted with
SMTP mail or with SASL authentication.

<p> Postfix version 2.2 introduces support for TLS as described in
RFC 3207.  TLS Support for older Postfix versions was available as
an add-on patch.  The section "<a href="#compat">Compatibility with
Postfix < 2.2 TLS support</a>" below discusses the differences
between these implementations.  </p>

<p> Topics covered in this document: </p>

<ul>

<li><a href="#how">How Postfix TLS support works</a>

<li><a href="#build_tls">Building Postfix with TLS support</a>

<li><a href="#server_tls">SMTP Server specific settings</a>

<li> <a href="#client_tls">SMTP Client specific settings</a>

<li><a href="#tlsmgr_controls"> TLS manager specific settings </a>

<li><a href="#problems"> Reporting problems </a>

<li><a href="#compat">Compatibility with Postfix < 2.2 TLS support</a>

<li><a href="#credits"> Credits </a>

</ul>

<p> And last but not least, for the impatient: </p>

<ul>

<li><a href="#quick-start">Getting started, quick and dirty</a>

</ul>

<h2><a name="how">How Postfix TLS support works</a></h2>

<p> The diagram below shows the main elements of the Postfix TLS
architecture and their relationships.  Colored boxes with numbered
names represent Postfix daemon programs. Other colored boxes
represent storage elements. </p>

<ul>

<li> <p> The smtpd(8) server implements the SMTP over TLS server
side. </p>

<li> <p> The smtp(8) client implements the SMTP over TLS client
side. </p>

<li> <p> The tlsmgr(8) server maintains the pseudo-random number
generator (PRNG) that seeds the TLS engines in the smtpd(8) server
and smtp(8) client processes, and maintains the TLS session key
cache files. </p>

</ul>

<table>

<tr> <td>Network<tt>-&gt; </tt> </td> <td align="center"
bgcolor="#f0f0ff"> <br> <a href="smtpd.8.html">smtpd(8)</a> <br> &nbsp; </td> <td colspan="2">

<tt> &lt;---seed---<br><br>&lt;-session-&gt; </tt> </td> <td
align="center" bgcolor="#f0f0ff"> <br> <a href="tlsmgr.8.html">tlsmgr(8)</a> <br> &nbsp; </td>
<td colspan="3"> <tt> ---seed---&gt;<br> <br>&lt;-session-&gt;

</tt> </td> <td align="center" bgcolor="#f0f0ff"> <br> <a href="smtp.8.html">smtp(8)</a> <br>
&nbsp; </td> <td> <tt> -&gt;</tt>Network </td> </tr>

<tr> <td colspan="3"> </td> <td align="right"> <table> <tr> <td>

</td> <td> / </td> </tr> <tr> <td> / </td> <td> </td> </tr> </table>
</td> <td align="center"> |<br> |</td> <td align="left"> <table>

<tr> <td> \ </td> <td> </td> </tr> <tr> <td> </td> <td> \ </td>
</tr> </table> </td> <td colspan="3"> </td> </tr>

<tr> <td colspan="2"> </td> <td align="center" bgcolor="#f0f0ff">
smtpd<br> session<br> key cache </td> <td> </td> <td align="center"
bgcolor="#f0f0ff"> PRNG<br> state <br>file </td> <td> </td> <td
align="center" bgcolor="#f0f0ff"> smtp<br> session<br> key cache
</td>

<td colspan="2"> </td> </tr>

</table>

<h2><a name="build_tls">Building Postfix with TLS support</a></h2>

<p> To build Postfix with TLS support, first we need to generate
the <tt>make(1)</tt> files with the necessary definitions. This is
done by invoking the command "<tt>make makefiles</tt>" in the Postfix
top-level directory and with arguments as shown next. </p>

<ul>

<li> <p> If the OpenSSL include files (such as <tt>ssl.h</tt>) are
in directory <tt>/usr/include/openssl</tt>, and the OpenSSL libraries
(such as <tt>libssl.so</tt> and <tt>libcrypto.so</tt>) are in
directory <tt>/usr/lib</tt>:  </p>

<blockquote>
<pre>
% <b>make tidy</b> # if you have left-over files from a previous build
% <b>make makefiles CCARGS="-DUSE_TLS" AUXLIBS="-lssl -lcrypto"</b>
</pre>
</blockquote>

<li> <p> If the OpenSSL include files (such as <tt>ssl.h</tt>) are
in directory <tt>/usr/local/include/openssl</tt>, and the OpenSSL
libraries (such as <tt>libssl.so</tt> and <tt>libcrypto.so</tt>)
are in directory <tt>/usr/local/lib</tt>:  </p>

<blockquote>
<pre>
% <b>make tidy</b> # if you have left-over files from a previous build
% <b>make makefiles CCARGS="-DUSE_TLS -I/usr/local/include" \
    AUXLIBS="-L/usr/local/lib -lssl -lcrypto" </b>
</pre>
</blockquote>

<p> On Solaris, specify the <tt>-R</tt> option as shown below:

<blockquote>
<pre>
% <b>make tidy</b> # if you have left-over files from a previous build
% <b>make makefiles CCARGS="-DUSE_TLS -I/usr/local/include" \
    AUXLIBS="-R/usr/local/lib -L/usr/local/lib -lssl -lcrypto" </b>
</pre>
</blockquote>

</ul>

<p> If you need to apply other customizations (such as Berkeley DB
databases, MySQL, PosgreSQL, LDAP or SASL), see the respective
Postfix README documents, and combine their "<tt>make makefiles</tt>"
instructions with the instructions above:  </p>

<blockquote>
<pre>
% <b>make tidy</b> # if you have left-over files from a previous build
% <b>make makefiles CCARGS="-DUSE_TLS \
    <i>(other -D or -I options)</i>" \
    AUXLIBS="-lssl -lcrypto \
    <i>(other -l options for libraries in /usr/lib)</i> \
    <i>(-L/path/name + -l options for other libraries)</i>"</b>
</pre>
</blockquote>

<p> To complete the build process, see the Postfix INSTALL
instructions. Postfix has TLS support turned off by default, so
you can start using Postfix as soon as it is installed.  </p>

<h2><a name="server_tls">SMTP Server specific settings</a></h2>

<p> Topics covered in this section: </p>

<ul>

<li><a href="#server_cert_key">Server-side certificate and private
key configuration </a>

<li><a href="#server_logging"> Server-side TLS activity logging
</a>

<li><a href="#server_enable">Enabling TLS in the Postfix SMTP server </a>

<li><a href="#server_vrfy_client">Client certificate verification</a>

<li><a href="#server_tls_auth">Supporting AUTH over TLS only</a>

<li><a href="#server_tls_cache">Server-side TLS session cache</a>

<li><a href="#server_access">Server access control</a>

<li><a href="#server_cipher">Server-side cipher controls</a>

<li><a href="#server_misc"> Miscellaneous server controls</a>

</ul>

<h3><a name="server_cert_key">Server-side certificate and private
key configuration </a> </h3>

<p> In order to use TLS, the Postfix SMTP server needs a certificate
and a private key. Both must be in "pem" format. The private key
must not be encrypted, meaning:  the key must be accessible without
password.  Both certificate and private key may be in the same
file.  </p>

<p> Both RSA and DSA certificates are supported. Typically you will
only have RSA certificates issued by a commercial CA. In addition,
the tools supplied with OpenSSL will by default issue RSA certificates.
You can have both at the same time, in which case the cipher used
determines which certificate is presented. For Netscape and OpenSSL
clients without special cipher choices, the RSA certificate is
preferred. </p>

<p> In order for remote SMTP clients to check the Postfix SMTP
server certificates, the CA certificate (in case of a certificate
chain, all CA certificates) must be available.  You should add
these certificates to the server certificate, the server certificate
first, then the issuing CA(s).  </p>

<p> Example: the certificate for "server.dom.ain" was issued by
"intermediate CA" which itself has a certificate issued by "root
CA".  Create the server.pem file with: </p>

<blockquote>
<pre>
% <b>cat server_cert.pem intermediate_CA.pem &gt; server.pem</b>
</pre>
</blockquote>

<p> A Postfix SMTP server certificate supplied here must be usable
as SSL server certificate and hence pass the "openssl verify -purpose
sslserver ..." test. </p>

<p> A client that trusts the root CA has a local copy of the root
CA certificate, so it is not necessary to include the root CA
certificate here.  Leaving it out of the "server.pem" file reduces
the overhead of the TLS exchange. </p>

<p> If you want the Postfix SMTP server to accept remote SMTP client
certificates issued by these CAs, append the root certificate to
$smtpd_tls_CAfile or install it in the $smtpd_tls_CApath directory.  When
you configure trust in a root CA, it is not necessary to explicitly trust
intermediary CAs signed by the root CA, unless $smtpd_tls_verify_depth
is less than the number of CAs in the certificate chain for the clients
of interest. With a verify depth of 1 you can only verify certificates
directly signed by a trusted CA, and all trusted intermediary CAs need to
be configured explicitly. With a verify depth of 2 you can verify clients
signed by a root CA or a direct intermediary CA (so long as the client
is correctly configured to supply its intermediate CA certificate). </p>

<p> RSA key and certificate examples: </p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_cert_file = /etc/postfix/server.pem
    smtpd_tls_key_file = $smtpd_tls_cert_file
</pre>
</blockquote>

<p> Their DSA counterparts: </p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_dcert_file = /etc/postfix/server-dsa.pem
    smtpd_tls_dkey_file = $smtpd_tls_dcert_file
</pre>  
</blockquote>

<p> To verify a remote SMTP client certificate, the Postfix SMTP
server needs to trust the certificates of the issuing certification
authorities. These certificates in "pem" format can be stored in a
single $smtpd_tls_CAfile or in multiple files, one CA per file in
the $smtpd_tls_CApath directory. If you use a directory, don't forget
to create the necessary "hash" links with: </p>

<blockquote>
<pre>
# <b>$OPENSSL_HOME/bin/c_rehash <i>/path/to/directory</i> </b>
</pre>
</blockquote>

<p> The $smtpd_tls_CAfile contains the CA certificates of one or
more trusted CAs. The file is opened (with root privileges) before
Postfix enters the optional chroot jail and so need not be accessible
from inside the chroot jail. </p>

<p> Additional trusted CAs can be specified via the $smtpd_tls_CApath
directory, in which case the certificates are read (with $mail_owner
privileges) from the files in the directory when the information
is needed. Thus, the $smtpd_tls_CApath directory needs to be
accessible inside the optional chroot jail. </p>

<p> When you configure Postfix to request client certificates (by
setting $smtpd_tls_asck_ccert = yes), any certificates in
$smtpd_tls_CAfile are sent to the client, in order to allow it to
choose an identity signed by a CA you trust. If no $smtpd_tls_CAfile
is specified, no preferred CA list is sent, and the client is free
to choose an identity signed by any CA. Many clients use a fixed
identity regardless of the preferred CA list and you may be able
to reduce TLS negotiation overhead by installing client CA certificates
mostly or only in $smtpd_tls_CApath. In the latter case you need
not specify a $smtpd_tls_CAfile. </p>

<p> Note, that unless client certificates are used to allow greater
access to TLS authenticated clients, it is best to not ask for
client certificates at all, as in addition to increased overhead
some clients (notably in some cases qmail) are unable to complete
the TLS handshake when client certificates are requested. </p>

<p> Example: </p>
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_CAfile = /etc/postfix/CAcert.pem
    smtpd_tls_CApath = /etc/postfix/certs
</pre>
</blockquote>

<h3><a name="server_logging"> Server-side TLS activity logging </a> </h3>

<p> To get additional information about Postfix SMTP server TLS
activity you can increase the loglevel from 0..4. Each logging
level also includes the information that is logged at a lower
logging level. </p>

<blockquote>

<table>

<tr> <td> 0 </td> <td> Disable logging of TLS activity.</td> </tr>

<tr> <td> 1 </td> <td> Log TLS handshake and certificate information.
</td> </tr>

<tr> <td> 2 </td> <td> Log levels during TLS negotiation.  </td>
</tr>

<tr> <td> 3 </td> <td> Log hexadecimal and ASCII dump of TLS
negotiation process </td> </tr>

<tr> <td> 4 </td> <td> Log hexadecimal and ASCII dump of complete
transmission after STARTTLS </td> </tr>

</table>

</blockquote>

<p> Use loglevel 3 only in case of problems. Use of loglevel 4 is
strongly discouraged. </p>

<p> Example: </p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_loglevel = 0
</pre>
</blockquote>

<p> To include information about the protocol and cipher used as
well as the client and issuer CommonName into the "Received:"
message header, set the smtpd_tls_received_header variable to true.
The default is no, as the information is not necessarily authentic.
Only information recorded at the final destination is reliable,
since the headers may be changed by intermediate servers. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_received_header = yes
</pre>
</blockquote>

<h3><a name="server_enable">Enabling TLS in the Postfix SMTP server </a> </h3>

<p> By default, TLS is disabled in the Postfix SMTP server, so no
difference to plain Postfix is visible.  Explicitly switch it on
using "smtpd_use_tls = yes". </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_use_tls = yes
</pre>
</blockquote>

<p> With this, Postfix SMTP server announces STARTTLS support to
SMTP clients, but does not require that clients use TLS encryption.
</p>

<p> Note: when an unprivileged user invokes "sendmail -bs", STARTTLS
is never offered due to insufficient privileges to access the server
private key. This is intended behavior. </p>

<p> You can ENFORCE the use of TLS, so that the Postfix SMTP server
announces STARTTLS and accepts no mail without TLS encryption, by
setting "smtpd_enforce_tls = yes". According to RFC 2487 this MUST
NOT be applied in case of a publicly-referenced Postfix SMTP server.
This option is off by default and should only seldom be used. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_enforce_tls = yes
</pre>
</blockquote>

<p> TLS is sometimes used in the non-standard "wrapper" mode where
a server always uses TLS, instead of announcing STARTTLS support
and waiting for clients to request TLS service. Some clients, namely
Outlook [Express] prefer the "wrapper" mode.  This is true for OE
(Win32 &lt; 5.0 and Win32 &gt;=5.0 when run on a port&lt;&gt;25
and OE (5.01 Mac on all ports). </p>

<p> It is strictly discouraged to use this mode from main.cf. If
you want to support this service, enable a special port in master.cf
and specify "-o smtpd_tls_wrappermode = yes" as an smtpd(8) command
line option.  Port 465 (smtps) was once chosen for this feature.
</p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/master.cf:
    smtps    inet  n       -       n       -       -       smtpd
      -o smtpd_tls_wrappermode=yes -o smtpd_sasl_auth_enable=yes
</pre>
</blockquote>

<h3><a name="server_vrfy_client">Client certificate verification</a> </h3>

<p> To receive a remote SMTP client certificate, the Postfix SMTP
server must explicitly ask for one (any contents of $smtpd_tls_CAfile
are also sent to the client as a hint for choosing a certificate
from a suitable CA). Unfortunately, Netscape clients will either
complain if no matching client certificate is available or will
offer the user client a list of certificates to choose from.
Additionally some MTAs (notably some versions of qmail) are unable
to complete TLS negotiation when client certificates are requested,
and abort the SMTP session. So this option is "off" by default.
You will however need the certificate if you want to use certificate
based relaying with, for example, the permit_tls_clientcerts
feature.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_ask_ccert = no
</pre>
</blockquote>

<p> You may also decide to REQUIRE a remote SMTP client certificate
before allowing TLS connections.  This feature is included for
completeness, and implies "smtpd_tls_ask_ccert = yes".  </p>

<p> Please be aware, that this will inhibit TLS connections without
a proper client certificate and that it makes sense only when
non-TLS submission is disabled (smtpd_enforce_tls = yes). Otherwise,
clients could bypass the restriction by simply not using STARTTLS
at all. </p>

<p> When TLS is not enforced, the connection will be handled as
if only "smtpd_tls_ask_ccert = yes" is specified, and a warning is
logged. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_req_ccert = no
</pre>
</blockquote>

<p> A client certificate verification depth of 1 is sufficient if
the certificate is directly issued by a CA listed in the CA file.
The default value (5) should also suffice for longer chains (root
CA issues special CA which then issues the actual certificate...)
</p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_ccert_verifydepth = 5
</pre>
</blockquote>

<h3><a name="server_tls_auth">Supporting AUTH over TLS only</a></h3>

<p> Sending AUTH data over an unencrypted channel poses a security
risk. When TLS layer encryption is required (smtpd_enforce_tls =
yes), the Postfix SMTP server will announce and accept AUTH only
after the TLS layer has been activated with STARTTLS. When TLS
layer encryption is optional (smtpd_enforce_tls = no), it may
however still be useful to only offer AUTH when TLS is active. To
maintain compatibility with non-TLS clients, the default is to
accept AUTH without encryption. In order to change this behavior,
set "smtpd_tls_auth_only = yes". </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_auth_only = no
</pre>
</blockquote>

<h3><a name="server_tls_cache">Server-side TLS session cache</a> </h3>

<p> The Postfix SMTP server and the remote SMTP client negotiate
a session, which takes some computer time and network bandwidth.
By default, this session information is cached only in the smtpd(8)
process actually using this session and is lost when the process
terminates.  To share the session information between multiple
smtpd(8) processes, a persistent session cache can be used. You
can specify any database type that can store objects of several
kbytes and that supports the sequence operator. DBM databases are
not suitable because they can only store small objects. The cache
is maintained by the tlsmgr(8) process, so there is no problem with
concurrent access. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_session_cache_database = btree:/etc/postfix/smtpd_scache
</pre>
</blockquote>

<p> Cached Postfix SMTP server session information expires after
a certain amount of time.  Postfix/TLS does not use the OpenSSL
default of 300s, but a longer time of 3600sec (=1 hour). RFC 2246
recommends a maximum of 24 hours.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_session_cache_timeout = 3600s
</pre>
</blockquote>

<h3><a name="server_access">Server access control</a> </h3>

<p> Postfix TLS support introduces three additional features for
Postfix SMTP server access control:  </p>

<blockquote>

<dl>

<dt> permit_tls_clientcerts </dt> <dd> <p> Allow the remote SMTP
client SMTP request if the client certificate passes verification,
and if its fingerprint is listed in the list of client certificates
(see relay_clientcerts discussion below). </p> </dd>

<dt> permit_tls_all_clientcerts </dt> <dd> <p> Allow the remote
client SMTP request if the client certificate passes verification.
</p> </dd>

<dt> check_ccert_access type:table</dt> <dd>
<p> If the client certificate passes verification, use its fingerprint
as a key for the specified access(5) table. </p> </dd>

</dl>

</blockquote>

<p> The permit_tls_all_clientcerts feature must be used with caution,
because it can result in too many access permissions.  Use this
feature only if a special CA issues the client certificates, and
only if this CA is listed as trusted CA. If other CAs are trusted,
any owner of a valid client certificate would be authorized.
The permit_tls_all_clientcerts feature can be practical for a
specially created email relay server.  </p>

<p> It is however recommended to stay with the permit_tls_clientcerts
feature and list all certificates via $relay_clientcerts, as
permit_tls_all_clientcerts does not permit any control when a
certificate must no longer be used (e.g. an employee leaving). </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_recipient_restrictions = 
        ... 
        permit_tls_clientcerts 
        reject_unauth_destination
        ...
</pre>
</blockquote>

<p> The Postfix list manipulation routines give special treatment
to whitespace and some other characters, making the use of certificate
names unpractical.  Instead we use the certificate fingerprints as
they are difficult to fake but easy to use for lookup.  Postfix
lookup tables are in the form of (key, value) pairs.  Since we only
need the key, the value can be chosen freely, e.g.  the name of
the user or host.</p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    relay_clientcerts = hash:/etc/postfix/relay_clientcerts

/etc/postfix/relay_clientcerts:
    D7:04:2F:A7:0B:8C:A5:21:FA:31:77:E1:41:8A:EE:80 lutzpc.at.home
</pre>
</blockquote>

<h3><a name="server_cipher">Server-side cipher controls</a> </h3>

<p> To influence the Postfix SMTP server cipher selection scheme,
you can give cipherlist string.  A detailed description would go
to far here; please refer to the OpenSSL documentation.  If you
don't know what to do with it, simply don't touch it and leave the
(openssl-)compiled in default! </p>

<p> DO NOT USE " to enclose the string, specify just the string!!! </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_cipherlist = DEFAULT
</pre>
</blockquote>

<p> If you want to take advantage of ciphers with EDH, DH parameters
are needed.  Instead of using the built-in DH parameters for both
1024bit and 512bit, it is better to generate "own" parameters,
since otherwise it would "pay" for a possible attacker to start a
brute force attack against parameters that are used by everybody.
For this reason, the parameters chosen are already different from
those distributed with other TLS packages. </p>

<p> To generate your own set of DH parameters, use: </p>

<blockquote>
<pre>
% <b>openssl gendh -out /etc/postfix/dh_1024.pem -2 -rand /var/run/egd-pool 1024</b>
% <b>openssl gendh -out /etc/postfix/dh_512.pem -2 -rand /var/run/egd-pool 512</b>
</pre>
</blockquote>

<p> Examples: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_tls_dh1024_param_file = /etc/postfix/dh_1024.pem
    smtpd_tls_dh512_param_file = /etc/postfix/dh_512.pem
</pre>
</blockquote>

<h3><a name="server_misc"> Miscellaneous server controls</a> </h3>

<p> The smtpd_starttls_timeout parameter limits the time of Postfix
SMTP server write and read operations during TLS startup and shutdown
handshake procedures.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtpd_starttls_timeout = 300s
</pre>
</blockquote>

<h2> <a name="client_tls">SMTP Client specific settings</a> </h2>

<p> Topics covered in this section: </p>

<ul>

<li><a href="#client_cert_key">Client-side certificate and private
key configuration </a>

<li><a href="#client_logging"> Client-side TLS activity logging
</a>

<li><a href="#client_tls_cache">Client-side TLS session cache</a>

<li><a href="#client_tls"> Enabling TLS in the Postfix SMTP client </a>

<li><a href="#client_vrfy_server">Server certificate verification</a>

<li> <a href="#client_cipher">Client-side cipher controls </a>

<li> <a href="#client_misc"> Miscellaneous client controls </a>

</ul>

<h3><a name="client_cert_key">Client-side certificate and private
key configuration </a> </h3>

<p> During TLS startup negotiation the Postfix SMTP client may present
a certificate to the remote SMTP server.  The Netscape client is
rather clever here and lets the user select between only those
certificates that match CA certificates offered by the remote SMTP
server. As the Postfix SMTP client uses the "SSL_connect()" function
from the OpenSSL package, this is not possible and we have to choose
just one certificate.  So for now the default is to use _no_
certificate and key unless one is explicitly specified here. </p>

<p> Both RSA and DSA certificates are supported.  You can have both
at the same time, in which case the cipher used determines which
certificate is presented.  </p>

<p> It is possible for the Postfix SMTP client to use the same
key/certificate pair as the Postfix SMTP server.  If a certificate
is to be presented, it must be in "pem" format. The private key
must not be encrypted, meaning: it must be accessible without
password. Both parts (certificate and private key) may be in the
same file. </p>

<p> In order for remote SMTP servers to verify the Postfix SMTP
client certificates, the CA certificate (in case of a certificate
chain, all CA certificates) must be available.  You should add
these certificates to the client certificate, the client certificate
first, then the issuing CA(s). </p>

<p> Example: the certificate for "client.example.com" was issued by
"intermediate CA" which itself has a certificate of "root CA".
Create the client.pem file with: </p>

<blockquote>
<pre>
% <b>cat client_cert.pem intermediate_CA.pem &gt; client.pem </b>
</pre>
</blockquote>

<p> A Postfix SMTP client certificate supplied here must be usable
as SSL client certificate and hence pass the "openssl verify -purpose
sslclient ..." test. </p>

<p> A server that trusts the root CA has a local copy of the root
CA certificate, so it is not necessary to include the root CA
certificate here. Leaving it out of the "client.pem" file reduces
the overhead of the TLS exchange. </p>

<p> If you want the Postfix SMTP client to accept remote SMTP server
certificates issued by these CAs, append the root certificate to
$smtp_tls_CAfile or install it in the $smtp_tls_CApath directory.  When
you configure trust in a root CA, it is not necessary to explicitly trust
intermediary CAs signed by the root CA, unless $smtp_tls_verify_depth
is less than the number of CAs in the certificate chain for the servers
of interest. With a verify depth of 1 you can only verify certificates
directly signed by a trusted CA, and all trusted intermediary CAs need to
be configured explicitly. With a verify depth of 2 you can verify servers
signed by a root CA or a direct intermediary CA (so long as the server
is correctly configured to supply its intermediate CA certificate). </p>

<p> RSA key and certificate examples: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_cert_file = /etc/postfix/client.pem
    smtp_tls_key_file = $smtp_tls_cert_file
</pre>
</blockquote>

<p> Their DSA counterparts: </p>

<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_dcert_file = /etc/postfix/client-dsa.pem
    smtp_tls_dkey_file = $smtpd_tls_cert_file
</pre>  
</blockquote>

<p> To verify a remote SMTP server certificate, the Postfix SMTP
client needs to trust the certificates of the issuing certification
authorities. These certificates in "pem" format can be stored in a
single $smtp_tls_CAfile or in multiple files, one CA per file in
the $smtp_tls_CApath directory. If you use a directory, don't forget
to create the necessary "hash" links with: </p>

<blockquote>
<pre>
# <b>$OPENSSL_HOME/bin/c_rehash <i>/path/to/directory</i> </b>
</pre>
</blockquote>

<p> The $smtp_tls_CAfile contains the CA certificates of one or more
trusted CAs. The file is opened (with root privileges) before Postfix
enters the optional chroot jail and so need not be accessible from inside the
chroot jail. </p>

<p> Additional trusted CAs can be specified via the $smtp_tls_CApath
directory, in which case the certificates are read (with $mail_owner
privileges) from the files in the directory when the information
is needed. Thus, the $smtp_tls_CApath directory needs to be accessible
inside the optional chroot jail.  </p>

<p> The choice between $smtp_tls_CAfile and $smtpd_tls_CApath is
a space/time tradeoff. If there are many trusted CAs, the cost of
preloading them all into memory may not pay off in reduced access time
when the certificate is needed.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_CAfile = /etc/postfix/CAcert.pem
    smtp_tls_CApath = /etc/postfix/certs
</pre>
</blockquote>

<h3><a name="client_logging"> Client-side TLS activity logging </a> </h3>

<p> To get additional information about Postfix SMTP client TLS
activity you can increase the loglevel from 0..4. Each logging
level also includes the information that is logged at a lower
logging level. </p>

<blockquote>

<table>

<tr> <td> 0 </td> <td> Disable logging of TLS activity.</td> </tr>

<tr> <td> 1 </td> <td> Log TLS handshake and certificate information.
</td> </tr>

<tr> <td> 2 </td> <td> Log levels during TLS negotiation.  </td>
</tr>

<tr> <td> 3 </td> <td> Log hexadecimal and ASCII dump of TLS
negotiation process </td> </tr>

<tr> <td> 4 </td> <td> Log hexadecimal and ASCII dump of complete
transmission after STARTTLS </td> </tr>

</table>

</blockquote>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_loglevel = 0
</pre>
</blockquote>

<h3><a name="client_tls_cache">Client-side TLS session cache</a> </h3>

<p> The remote SMTP server and the Postfix SMTP client negotiate a
session, which takes some computer time and network bandwidth.  By
default, this session information is cached only in the smtp(8)
process actually using this session and is lost when the process
terminates.  To share the session information between multiple
smtp(8) processes, a persistent session cache can be used. You
can specify any database type that can store objects of several
kbytes and that supports the sequence operator. DBM databases are
not suitable because they can only store small objects. The cache
is maintained by the tlsmgr(8) process, so there is no problem with
concurrent access. </p>


<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_session_cache_database = btree:/etc/postfix/smtp_scache
</pre>
</blockquote>

<p> Cached Postfix SMTP client session information expires after
a certain amount of time.  Postfix/TLS does not use the OpenSSL
default of 300s, but a longer time of 3600s (=1 hour). RFC 2246
recommends a maximum of 24 hours.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_session_cache_timeout = 3600s
</pre>
</blockquote>

<h3><a name="client_tls"> Enabling TLS in the Postfix SMTP client </a>
</h3>

<p> By default, TLS is disabled in the Postfix SMTP client, so no
difference to plain Postfix is visible.  If you enable TLS, the
Postfix SMTP client will send STARTTLS when TLS support is announced
by the remote SMTP server. </p>

<p> WARNING: MS Exchange servers will announce STARTTLS support
even when the service is not configured, so that the TLS handshake
will fail.  It may be wise to not use this option on your central
mail hub, as you don't know in advance whether you are going to
connect to such a host. Instead, use the smtp_tls_per_site
recipient/site specific options that are described below. </p>

<p> When the TLS handshake fails and no other server is available,
the Postfix SMTP client defers the delivery attempt, and the mail
stays in the queue.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_use_tls = yes
</pre>
</blockquote>

<p> You can ENFORCE the use of TLS, so that the Postfix SMTP client
will not deliver mail over unencrypted connections.  In this mode,
the remote SMTP server hostname must match the information in the
remote server certificate, and the server certificate must be issued
by a CA that is trusted by the Postfix SMTP client.  If the remote
server certificate doesn't verify or the remote SMTP server hostname
doesn't match, and no other server is available, the delivery
attempt is deferred and the mail stays in the queue.  </p>

<p> The remote SMTP server hostname used in the check is beyond
question, as it must be the principal hostname (no CNAME allowed
here). Checks are performed against all names provided as dNSNames
in the SubjectAlternativeName. If no dNSNames are specified, the
CommonName is checked.  The behavior may be changed with the
smtp_tls_enforce_peername option which is discussed below. </p>

<p> This option is useful only if you know that you will only
connect to servers that support RFC 2487 _and_ that present server
certificates that meet the above requirements.  An example would
be a client only sends email to one specific mailhub that offers
the necessary STARTTLS support.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_enforce_tls = no
</pre>
</blockquote>

<p> As of RFC 2487 the requirements for hostname checking for MTA
clients are not set. When TLS is required (smtp_enforce_tls = yes),
the option smtp_tls_enforce_peername can be set to "no" to disable
strict remote SMTP server hostname checking. In this case, the mail
delivery will proceed regardless of the CommonName etc. listed in
the certificate. </p>

<p> Note: the smtp_tls_enforce_peername setting has no effect on
sessions that are controlled via the smtp_tls_per_site table.  </p>

<p>  Disabling the remote SMTP server hostname verification can
make sense in closed environment where special CAs are created.
If not used carefully, this option opens the danger of a
"man-in-the-middle" attack (the CommonName of this possible attacker
is logged). </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_enforce_peername = yes
</pre>
</blockquote>

<p> Generally, trying TLS can be a bad idea, as some servers offer
STARTTLS but the negotiation will fail leading to unexplainable
failures. Instead, it may be a good idea to choose the TLS usage
policy based on the recipient or the mailhub to which you are
connecting. </p>

<p> Deciding the TLS usage policy per recipient may be difficult,
since a single email delivery attempt can involve several recipients.
Instead, use of TLS is controlled by the Postfix next-hop destination
domain name and by the remote SMTP server hostname.  If either of these
matches an entry in the smtp_tls_per_site table, appropriate action
is taken.  </p>

<p> The remote SMTP server hostname is simply the DNS name of the
server that the Postfix SMTP client connects to.  The next-hop
destination is Postfix specific.  By default, this is the domain
name in the recipient address, but this information can be overruled
by the transport(5) table or by the relayhost parameter setting.
In these cases the relayhost etc. must be listed in the smtp_tls_per_site
table, instead of the recipient domain name. </p>

<p> Format of the table: domain or host names are specified on the
left-hand side; no wildcards are allowed.  On the right hand side
specify one of the following keywords:  </p>

<blockquote>

<dl>

<dt> NONE </dt> <dd> Don't use TLS at all. </dd>

<dt> MAY </dt> <dd> Try to use STARTTLS if offered, otherwise use
the unencrypted connection. </dd>

<dt> MUST </dt> <dd> Require usage of STARTTLS, require that the
remote SMTP server hostname matches the information in the remote
SMTP server certificate, and require that the remote SMTP server
certificate was issued by a trusted CA. </dd>

<dt> MUST_NOPEERMATCH </dt> <dd> Require usage of STARTTLS, but do
not require that the remote SMTP server hostname matches the
information in the remote SMTP server certificate, or that the
server certificate was issued by a trusted CA. </dd>

</dl>

</blockquote>

<p> The actual TLS usage policy depends not only on whether the
next-hop destination or remote SMTP server hostname are found in
the smtp_tls_per_site table, but also on the smtp_enforce_tls
setting:  </p>

<ul>

<li> <p> If no match was found, the policy is applied as specified
with smtp_enforce_tls. </p>

<li> <p> If a match was found, and the smtp_enforce_tls policy is
"enforce", NONE explicitly switches it off; otherwise the "enforce"
mode is used even for entries that specify MAY. </p>

</ul>

<p> Special hint for TLS enforcement mode:  since no secure DNS
lookup mechanism is available, mail can be delivered to the wrong
remote SMTP server. This is not prevented by specifying MUST for
the next-hop domain name.  The recommended setup is:  specify local
transport(5) table entries for sensitive domains with explicit
smtp:[mailhost] destinations (since you can assure security of this
table unlike DNS), then specify MUST for these mail hosts in the
smtp_tls_per_site table. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_per_site = hash:/etc/postfix/tls_per_site
</pre>
</blockquote>

<p> As we decide on a "per site" basis whether or not to use TLS,
it would be good to have a list of sites that offered "STARTTLS".
We can collect it ourselves with this option. </p>

<p> If the smtp_tls_note_starttls_offer feature is enabled and a
server offers STARTTLS while TLS is not already enabled for that
server, the Postfix SMTP client logs a line as follows: </p>

<blockquote>
<pre>
postfix/smtp[pid]: Host offered STARTTLS: [hostname.example.com]
</pre>
</blockquote>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_note_starttls_offer = yes
</pre>
</blockquote>

<h3><a name="client_vrfy_server">Server certificate verification</a> </h3>

<p> When verifying a remote SMTP server certificate, a verification
depth of 1 is sufficient if the certificate is directly issued by
a CA specified with smtp_tls_CAfile or smtp_tls_CApath.  The default
value of 5 should also suffice for longer chains (root CA issues
special CA which then issues the actual certificate...) </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_scert_verifydepth = 5
</pre>
</blockquote>

<h3> <a name="client_cipher">Client-side cipher controls </a> </h3>

<p> To influence the Postfix SMTP client cipher selection scheme,
you can give cipherlist string.  A detailed description would go
to far here; please refer to the OpenSSL documentation.  If you
don't know what to do with it, simply don't touch it and leave the
(openssl-)compiled in default! </p>

<p> DO NOT USE " to enclose the string, specify just the string!!! </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_tls_cipherlist = DEFAULT
</pre>
</blockquote>

<h3> <a name="client_misc"> Miscellaneous client controls </a> </h3>

<p> The smtp_starttls_timeout parameter limits the time of Postfix
SMTP client write and read operations during TLS startup and shutdown
handshake procedures.  In case of problems the Postfix SMTP client
tries the next network address on the mail exchanger list, and
defers delivery if no alternative server is available. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    smtp_starttls_timeout = 300s
</pre>
</blockquote>

<h2><a name="tlsmgr_controls"> TLS manager specific settings </a> </h2>

<p> The security of cryptographic software such as TLS depends
critically on the ability to generate unpredictable numbers for
keys and other information. To this end, the tlsmgr(8) process
maintains a Pseudo Random Number Generator (PRNG) pool.  This is
queried by the smtp(8) and smtpd(8) processes when they initialize.
By default, these daemons request 32 bytes, the equivalent to 256
bits. This is more than sufficient to generate a 128bit (or 168bit)
session key.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    tls_daemon_random_bytes = 32
</pre>
</blockquote>

<p> In order to feed its in-memory PRNG pool, the tlsmgr(8) reads
entropy from an external source, both at startup and during run-time.
Specify a good entropy source, like EGD or /dev/urandom; be sure
to only use non-blocking sources (on OpenBSD, use /dev/arandom
when tlsmgr(8) complains about /dev/urandom timeout errors).
If the entropy source is not a
regular file, you must prepend the source type to the source name:
"dev:" for a device special file, or "egd:" for a source with EGD
compatible socket interface.  </p>

<p> Examples (specify only one in main.cf): </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    tls_random_source = dev:/dev/urandom
    tls_random_source = egd:/var/run/egd-pool
</pre>
</blockquote>

<p> By default, tlsmgr(8) reads 32 bytes from the external entropy
source at each seeding event.  This amount (256bits) is more than
sufficient for generating a 128bit symmetric key.  With EGD and
device entropy sources, the tlsmgr(8) limits the amount of data
read at each step to 255 bytes. If you specify a regular file as
entropy source, a larger amount of data can be read.  </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    tls_random_bytes = 32
</pre>
</blockquote>

<p> In order to update its in-memory PRNG pool, the tlsmgr(8)
queries the external entropy source again after a pseudo-random
amount of time. The time is calculated using the PRNG, and is
between 0 and the maximal time specified with tls_random_reseed_period.
The default maximal time interval is 1 hour. </p>

<p> Example: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    tls_random_reseed_period = 3600s
</pre>
</blockquote>

<p> The tlsmgr(8) process saves the PRNG state to a persistent
exchange file at regular times and when the process terminates, so
that it can recover the PRNG state the next time it starts up.
This file is created when it does not exist. Its default location
is under the Postfix configuration directory, which is not the
proper place for information that is modified by Postfix.  Instead,
the file location should probably be on the /var partition (but
<b>not</b> inside the chroot jail).  </p>

<p> Examples: </p>
 
<blockquote>
<pre>
/etc/postfix/main.cf:
    tls_random_exchange_name = /etc/postfix/prng_exch
    tls_random_prng_update_period = 3600s
</pre>
</blockquote>

<h2><a name="quick-start">Getting started, quick and dirty</a></h2>

<p> The following steps will get you started quickly. Because you
sign your own Postfix public key certificate, you get TLS encryption
but no TLS authentication.  This is sufficient for testing, and
for exchanging email with sites that you have no trust relationship
with.  For real authentication, your Postfix public key certificate
needs to be signed by a recognized Certificate Authority, and
Postfix needs to be configured with a list of public key certificates
of Certificate Authorities, so that Postfix can verify the public key
certificates of remote hosts. </p>

<p> In the examples below, user input is shown in <b><tt>bold</tt></b>
font, and a "<tt>#</tt>" prompt indicates a super-user shell. </p>

<ul>

<li> <p> Become your own Certificate Authority, so that you can
sign your own public keys. This example uses the CA.pl script that
ships with OpenSSL.  By default, OpenSSL installs this as
<tt>/usr/local/ssl/misc/CA.pl</tt>, but your mileage may vary. 
The script creates a private key in <tt>./demoCA/private/cakey.pem</tt>
and a public key in <tt>./demoCA/cacert.pem</tt>.</p>

<blockquote>
<pre>
% <b>/usr/local/ssl/misc/CA.pl -newca</b>
CA certificate filename (or enter to create)

Making CA certificate ...
Using configuration from /etc/ssl/openssl.cnf
Generating a 1024 bit RSA private key
....................++++++
.....++++++
writing new private key to './demoCA/private/cakey.pem'
Enter PEM pass phrase:<b>whatever</b>
</pre>
</blockquote>

<li> <p> Create an unpassworded private key for host FOO and create
an unsigned public key certificate. </p>

<blockquote>
<pre>
% <b>openssl req -new -nodes -keyout FOO-key.pem -out FOO-req.pem -days 365</b>
Using configuration from /etc/ssl/openssl.cnf
Generating a 1024 bit RSA private key
........................................++++++
....++++++
writing new private key to 'FOO-key.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<b>US</b>
State or Province Name (full name) [Some-State]:<b>New York</b>
Locality Name (eg, city) []:<b>Westchester</b>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<b>Porcupine</b>
Organizational Unit Name (eg, section) []:
Common Name (eg, YOUR name) []:<b>FOO</b>
Email Address []:<b>wietse@porcupine.org</b>

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:<b>whatever</b>
An optional company name []:
</pre>
</blockquote>

<li> <p> Sign the public key certificate for host FOO with the
Certification Authority private key that we created a few
steps ago. </p>

<blockquote>
<pre>
% <b>openssl ca -out FOO-cert.pem -infiles FOO-req.pem</b>
Uing configuration from /etc/ssl/openssl.cnf
Enter PEM pass phrase:<b>whatever</b>
Check that the request matches the signature
Signature ok
The Subjects Distinguished Name is as follows
countryName           :PRINTABLE:'US'
stateOrProvinceName   :PRINTABLE:'New York'
localityName          :PRINTABLE:'Westchester'
organizationName      :PRINTABLE:'Porcupine'
commonName            :PRINTABLE:'FOO'
emailAddress          :IA5STRING:'wietse@porcupine.org'
Certificate is to be certified until Nov 21 19:40:56 2005 GMT (365 days)
Sign the certificate? [y/n]:<b>y</b>


1 out of 1 certificate requests certified, commit? [y/n]<b>y</b>
Write out database with 1 new entries
Data Base Updated
</pre>
</blockquote>

<li> <p> Install the host private key, the host public key certificate,
and the Certification Authority certificate files.  This requires
super-user privileges. </p>

<blockquote>
<pre>
# <b>cp demoCA/cacert.pem FOO-key.pem FOO-cert.pem /etc/postfix</b>
# <b>chmod 644 /etc/postfix/FOO-cert.pem /etc/postfix/cacert.pem</b>
# <b>chmod 400 /etc/postfix/FOO-key.pem</b>
</pre>
</blockquote>

<li> <p> Configure Postfix, by adding the following to
<tt>/etc/postfix/main.cf</tt>. </p>

<blockquote>
<pre>
smtp_tls_CAfile = /etc/postfix/cacert.pem
smtp_tls_cert_file = /etc/postfix/FOO-cert.pem
smtp_tls_key_file = /etc/postfix/FOO-key.pem
smtp_tls_session_cache_database = btree:/var/run/smtp_tls_session_cache
smtp_use_tls = yes
smtpd_tls_CAfile = /etc/postfix/cacert.pem
smtpd_tls_cert_file = /etc/postfix/FOO-cert.pem
smtpd_tls_key_file = /etc/postfix/FOO-key.pem
smtpd_tls_received_header = yes
smtpd_tls_session_cache_database = btree:/var/run/smtpd_tls_session_cache
smtpd_use_tls = yes
tls_random_source = dev:/dev/urandom
</pre>
</blockquote>

</ul>


<h2> <a name="problems"> Reporting problems </a> </h2>

<p> When reporting a problem, please be thorough in the report.
Patches, when possible, are greatly appreciated too. </p>

<p> Please differentiate when possible between: </p>

<ul>

<li> Problems in the TLS code: &lt;postfix_tls@aet.tu-cottbus.de&gt;

<li> Problems in vanilla Postfix: &lt;postfix-users@postfix.org&gt;

</ul>

<h2><a name="compat">Compatibility with Postfix <2.2 TLS support</a></h2>

<p> Postfix version 2.2 TLS support is based on the Postfix/TLS
patch by Lutz J&auml;nicke, but differs in a few minor ways. </p>

<ul>

<li> <p> main.cf: Specify "btree" instead of "sdbm" for TLS
session cache databases. </p>

<p> TLS session cache databases are now accessed only by the
tlsmgr(8) process, so there are no more concurrency issues. Although
Postfix has an sdbm client, the sdbm library (1000
lines of code) is not included with Postfix. </p>

<p> TLS session caches can use any database that can store objects
of several kbytes or more, and that implements the sequence operation.
In most cases, btree databases should be adequate.  </p>

<p> NOTE:  You cannot use dbm databases. TLS session objects
are too large. </p>

<li> <p> master.cf: Specify "unix" instead of "fifo" as
the tlsmgr service type. </p>

<p> The smtp(8) and smtpd(8) processes now use a client-server
protocol in order to access the tlsmgr(8) pseudo-random number
generation (PRNG) pool, and in order to access the TLS session
cache databases. Such a protocol cannot be run across fifos. </p>

</ul>

<h2><a name="credits">Credits </a> </h2>

<ul>

<li> TLS support for Postfix was originally developed by  Lutz
J&auml;nicke at Cottbus Technical University.

<li> Wietse Venema adopted the code, did some restructuring, and
compiled this part of the documentation from Lutz's documents.

</ul>

</body>

</html>
